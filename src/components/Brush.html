<g class="brush">
  <rect ref:area class="brush-area" width="{{extent[1]}}" :height />
  <rect class="brush-selection" on:drag="onselectionmove(event)"
    x="{{start}}" width="{{end - start}}" :height />
  <rect class="brush-handle" on:drag="onstartmove(event)"
    x="{{start - handleWidth}}" width="{{handleWidth}}" :height />
  <rect class="brush-handle" on:drag="onendmove(event)"
    x="{{end}}" width="{{handleWidth}}" :height />
</g>
<script>
  export default {
    namespace: "svg",
    
    data() {
      return {
        handleWidth: 1
      }
    },
    
    methods: {
      onstartmove(event) {
        const start = Math.max(
          this.get("start") + event,
          this.get("extent")[0]
        );
          
        this.fire("brush", [start, this.get("end")]);
      },
      
      onendmove(event) {
        const end = Math.min(
          this.get("end") + event,
          this.get("extent")[1]
        );
        
        this.fire("brush", [this.get("start"), end]);
      },
      
      onselectionmove(event) {
        const extent = this.get("extent");
        let start = this.get("start") + event,
          end = this.get("end") + event,
          width = end - start;
          
        // Prevent moving beyond edges of brush
        if (width > extent[1] - extent[0]) {
          start = extent[0];
          end = extent[1];
        } else if (start < extent[0]) {
          start = extent[0];
          end = start + width;
        } else if (end > extent[1]) {
          end = extent[1];
          start = end - width;
        }

        this.fire("brush", [start, end]);
      }
    },
    
    events: {
      drag(node, cb) {
        function onmousedown(event) {
          function onmouseup() {
            fire("brushend");
            window.removeEventListener("mouseup", onmouseup, false);
            window.removeEventListener("mousemove", onmousemove, false);
          }
          
          function onmousemove(event) {
            const dx = event.screenX - x0;
            x0 = event.screenX
            cb(dx);
          }
          
          let x0 = event.screenX;
          
          window.addEventListener("mouseup", onmouseup, false);
          window.addEventListener("mousemove", onmousemove, false);
        }
        
        const fire = this.fire.bind(this);
        
        node.addEventListener("mousedown", onmousedown, false);
        
        return {
          teardown() {
            node.removeEventListener("mousedown", onmousedown, false);
          }
        };
      }
    }
  };
</script>