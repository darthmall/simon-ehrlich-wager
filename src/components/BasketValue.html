<Chart class="frameless" bind:contentWidth="width" bind:contentHeight="height"
  :margin aspect="1.618">
  
  <g class="series basket-value" style="stroke: black; fill: black;">
    <Area data="{{totals}}" :x :y />
    
    {{#each annotations as a}}
      <Point x="{{a.x}}" y="{{a.y}}" datum="{{a.datum}}"
        align="{{a.align}}" :label />
    {{/each}}
  </g>
  
</Chart>

<script>
  import {extent} from "d3-array";
  import {nest} from "d3-collection";
  import {scaleLinear} from "d3-scale";
  
  import Area from "./Area.html";
  import Chart from "./Chart.html";
  import Point from "./Point.html";
  
  export default {
    namespace: "svg",
    
    components: {
      Area,
      Chart,
      Point
    },
    
    data() {
      return {
        width: 0,
        height: 0,
        margin: {
          top: 16,
          right: 64,
          bottom: 16,
          left: 64
        }
      };
    },
    
    computed: {
      totals: (prices) => {
        return nest()
          .key(d => d.year)
          .rollup(values => values.reduce((p, v) => p + v.value, 0))
          .entries(prices)
          .sort((a, b) => a.key - b.key);
      },
      
      x: (width, totals) => {
        return {
          value: d => d.key,
          format: String,
          scale: scaleLinear()
            .domain(extent(totals, d => d.key))
            .range([0, width]),
        };
      },
      
      y: (height, totals) => {
        return {
          value: d => d.value,
          format: String,
          scale: scaleLinear()
            .domain(extent(totals, d => d.value))
            .range([height, 0])
        };
      },
      
      annotations: (x, y, totals) => {
        function makeAnnotation(d, align) {
          return {
            x: x.scale(x.value(d)),
            y: y.scale(y.value(d)),
            datum: d,
            align
          };
        }
        
        const initial = totals[0],
          final = totals[totals.length - 1];
          
        return [makeAnnotation(initial, "left"), makeAnnotation(final, "right")];
      }
    },
    
    helpers: {
      label: (d) => {
        return `<tspan x="0">${d.value}</tspan>
          <tspan x="0" dy="1.1em">${d.key}</tspan>`;
      }
    }
  };
</script>